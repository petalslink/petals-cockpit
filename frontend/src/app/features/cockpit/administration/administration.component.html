<!-- Copyright (C) 2017 Linagora

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>. -->

<div fxLayout="column" fxFlex class="wrapper-content">
  <md-toolbar color="primary" class="toolbar-page-header">
    <div class="prefix-toolbar-title">
      <md-icon>settings</md-icon>
    </div>

    <h1 class="title" [ngClass.lt-md]="'margin-left-x1'">Administration</h1>
  </md-toolbar>

  <div fxFlexFill fxLayout="column" *ngIf="user$ | async as currentUser" class="content content-max-width">
    <div class="central-content" *ngIf="currentUser.isAdmin; else notAdmin">
      <div fxLayout="column" fxFlex *ngIf="users$ | async as users" class="user-management-page">
        <md-card fxLayout="column">
          <md-card-content>
            <div fxLayout="row" fxFlex="100%">
              <label class="text-upper">User Management</label>

              <div fxFlex fxLayoutAlign="end center" class="margin-right-x1">
                <md-spinner class="margin-right-x1" *ngIf="isFetchingUsers$ | async; else usersFetched"></md-spinner>
                <ng-template #usersFetched>
                  <span class="subtitle" *ngIf="users.length > 0" md-line>
                      {{ users.length }} user{{ (users.length) >= 2 ? 's' : '' }}
                    </span>
                </ng-template>
              </div>
              <md-icon color="primary">supervisor_account</md-icon>
            </div>
          </md-card-content>

          <md-card-subtitle fxLayout="row" fxLayoutAlign="start center">
            <md-icon color="primary">info</md-icon>
            <span class="color-primary">As an administrator, you can <b>ADD</b>, <b>EDIT</b>, and <b>DELETE</b> any user.</span>
          </md-card-subtitle>
        </md-card>

        <div fxLayout="column" fxLayout.gt-md="row" fxLayoutGap="10px" class="user-management-panels">

          <div fxFlex [ngClass.gt-md]="'card-auto-size'" class="pnl-add-user margin-top-x1">
            <md-expansion-panel #el fxLayout="column" class="exp-pnl-add-user" [hideToggle]="false" (closed)="addEditUser.reset()">
              <md-expansion-panel-header fxLayout="row">
                <div fxLayout="row" fxLayoutAlign="center center" class="mat-body">
                  <md-icon class="margin-right-x1" color="primary">person_add</md-icon>
                  <span class="text-upper pnl-title light-bold">Add a new user</span>
                </div>
              </md-expansion-panel-header>

              <app-add-edit-user #addEditUser
                (onSubmit)="onAdd($event); el.close()"
                (onCancel)="el.close()">
              </app-add-edit-user>

            </md-expansion-panel>
          </div>

          <div fxFlex [ngClass.gt-md]="'card-auto-size'" class="pnl-list-users margin-top-x1">
            <md-accordion displayMode="default" [multi]="false">
              <md-expansion-panel #el [hideToggle]="false" fxLayout="column" *ngFor="let user of users; trackBy:trackByUser" [class]="'exp-pnl-user-'+user.id" (closed)="addEditUser.reset()">

                <md-expansion-panel-header class="mat-body" fxLayout="row">
                  <mat-panel-title fxLayout="row" fxLayoutAlign="star center">
                    <app-generate-icon md-list-avatar [size]="35" [text]="user.id"></app-generate-icon>
                    <span class="margin-left-x1 user-id">{{ user.id }}</span>
                    <span class="margin-left-x1 light-bold user-name">({{ user.name }})</span>
                    <md-spinner class="margin-left-x1" *ngIf="user.isAdding || user.isModifying"></md-spinner>
                  </mat-panel-title>
                </md-expansion-panel-header>

                <app-add-edit-user #addEditUser
                  [canDelete]="user.id !== currentUser.id && !user.isDeleting"
                  [user]="user"
                  (onSubmit)="onSave(user.id, $event); el.close()"
                  (onDelete)="onDelete(user.id); el.close()"
                  (onCancel)="el.close()">
                </app-add-edit-user>

              </md-expansion-panel>
            </md-accordion>
            <md-progress-bar mode="indeterminate" color="primary" *ngIf="isFetchingUsers$ | async"></md-progress-bar>
          </div>
        </div>
      </div>
    </div>

    <ng-template #notAdmin>
      <div class="central-content">
        <div fxLayout="column">
          <md-card fxFlex [ngClass.gt-md]="'card-auto-size'" class="warning-not-admin margin-top-x1">
            <md-card-title fxLayout="row">
              <span fxFlex class="text-upper">Warning</span>
              <md-icon color="warn">warning</md-icon>
            </md-card-title>
            <md-card-subtitle fxLayout="row" fxLayoutAlign="start center">
              <md-icon class="margin-right-x1" color="primary">info</md-icon>
              <span class="color-primary" fxFlex>You are not an administrator.</span>
            </md-card-subtitle>
          </md-card>
        </div>
      </div>
    </ng-template>
  </div>
</div>
