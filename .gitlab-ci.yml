stages:
  - build
  - package
  - integration
  - deploy

variables:
  # it is also referenced in ci/settings.xml
  M2_STAGING_DIRECTORY: staging
  M2_CACHED_REPOSITORY: m2cache
  YARN_CACHE_DIRECTORY: yarncache
  DISPLAY: ":99"
  XVFB: "Xvfb $DISPLAY -ac -screen 0 1280x720x16 -nolisten tcp"

.mvn-java-8: &mvn-java-8
  image: maven:3.3-jdk-8-alpine
  before_script:
    - "source ci/mvn-helpers.sh"
  after_script:
    - "source ci/mvn-helpers.sh"
    - "maven ch.ringler.tools:m2cachecleanup:1.0.4:cleanup-cache"
  cache:
    key: "mvn-java-8"
    paths:
      - $M2_CACHED_REPOSITORY

.node-6: &node-6
  image: registry.gitlab.com/victornoel/petals-cockpit
  before_script:
    # see https://github.com/yarnpkg/yarn/issues/986 or https://github.com/yarnpkg/yarn/issues/988 for optimizing
    - "cd frontend"
    - "export PATH=`yarn bin`:$PATH"
    # see https://github.com/yarnpkg/yarn/issues/1316 for cache
    - "time yarn --cache-folder ../$YARN_CACHE_DIRECTORY --pure-lockfile"
    - "cd .."
  cache:
    key: "node-6-yarn"
    paths:
      - $YARN_CACHE_DIRECTORY

pages:
  <<: *node-6
  stage: deploy
  script:
    - "cd frontend"
    - "ng build -e=gitlab-pages -bh=/petals-cockpit/"
    - "mv dist ../public"
  artifacts:
    paths:
      - public
  only:
    - master

build-backend:
  <<: *mvn-java-8
  stage: build
  except:
    - /^front\/.*$/
  script:
      # let's lock the version used for SNAPSHOT dependencies to
      # ensure they are the same in the other jobs
    - "maven -pl backend -am versions:lock-snapshots"
    - "maven_build -pl backend -am deploy"
  artifacts:
    paths:
      - $M2_STAGING_DIRECTORY

build-frontend:
  <<: *node-6
  stage: build
  except:
    - /^back\/.*$/
  script:
    - "cd frontend"
    - "time ng lint"
    - "time node generate-headers.js --dry"
    - "nohup $XVFB &"
    - "XVFBPID=$!"
    - "time ng test --watch false"
    - "nohup ng serve -e=prod-e2e &"
    - "NGPID=$!"
    - "time ng e2e"
    - "kill $NGPID"
    - "kill $XVFBPID"
    - "time ng build --prod"
  artifacts:
    paths:
      - frontend/dist

build-product:
  <<: *mvn-java-8
  stage: package
  except:
    - /^front\/.*$/
    - /^back\/.*$/
  dependencies:
    - build-backend
    - build-frontend
  script:
    - 'maven dependency:purge-local-repository --non-recursive -DmanualInclude="org.ow2.petals:petals-cockpit-server,org.ow2.petals:petals-cockpit-parent" -DreResolve=false -DsnapshotsOnly=true'
    - "maven -pl cockpit package"
  artifacts:
    paths:
      - cockpit/target/petals-cockpit-*-capsule.jar

e2e-product:
  <<: *node-6
  stage: integration
  only:
    - master
    - integration
    - /^product\/.*$/
  dependencies:
    - build-product
  variables:
    COCKPIT: "java -Ddw.server.applicationConnectors[0].port=4200 -jar cockpit/target/petals-cockpit-*-capsule.jar"
  script:
    - "$COCKPIT db migrate cockpit/default.yml"
    - "$COCKPIT add-user -u admin -p admin -n Administrator cockpit/default.yml"
    - "nohup $COCKPIT server cockpit/default.yml &"
    - "nohup $XVFB &"
    - "cd frontend"
    - "ng e2e"
